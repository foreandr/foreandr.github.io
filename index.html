<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Andre's Portfolio</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
</head>
<body>
  <div id="navbar"></div>

  <div id="app">
    <h1>Welcome</h1>
    <p>Select a page from the nav bar above.</p>
  </div>

  <script src="js/utils.js"></script>

  <script>
    // Load navbar dynamically
    fetch("html/nav.html")
      .then(r => r.text())
      .then(html => {
        document.getElementById("navbar").innerHTML = html;

        // attach nav click handlers
        document.querySelectorAll("#navbar .site-nav a[data-page]").forEach(link => {
          link.addEventListener("click", e => {
            e.preventDefault();
            const page = link.getAttribute("data-page");

            fetch("html/" + page)
              .then(r => r.text())
              .then(html => {
                document.getElementById("app").innerHTML = html;
              });
          });
        });
      });

    // demo util
    const msg = greetUser("Andre");
    console.log(msg);
  </script>

  <script>
    /**
     * loadProject(fileName)
     */
    function loadProject(fileName) {
      console.log(`[CLICK] Loading project: ${fileName}`);
      const appContainer = document.getElementById('app');

      fetch("html/" + fileName)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.text();
        })
        .then(html => {
          if (appContainer) {
            appContainer.innerHTML = html;
            console.log('[CLICK] Replacement complete.');
          } else {
            console.error("The 'app' element was not found.");
          }
        })
        .catch(error => {
          console.error(`Could not load content for ${fileName}:`, error);
        });
    }

    // stub
    function generateProjection() {
      console.log("generateProjection stub");
    }
  </script>

  <script>
  // ==============================
  //  LANDLORD OPTIMIZATION GLOBALS
  //  (all logic here)
  // ==============================

  // ensure chart
  function LOP_ensureChartJs(cb) {
    if (window.Chart) {
      cb && cb();
      return;
    }
    var s = document.createElement('script');
    s.src = "https://cdn.jsdelivr.net/npm/chart.js";
    s.onload = function() { cb && cb(); };
    s.onerror = function() {
      console.warn("Chart.js failed to load.");
      cb && cb();
    };
    document.head.appendChild(s);
  }

  // spider bg
  function LOP_initSpiderBackground() {
    var c = document.getElementById('spiderweb');
    if (!c) return;
    var ctx = c.getContext('2d');

    function resize() {
      c.width = window.innerWidth;
      c.height = window.innerHeight;
    }
    resize();
    window.addEventListener('resize', resize);

    var nodes = [];
    for (var i = 0; i < 50; i++) {
      nodes.push({
        x: Math.random() * c.width,
        y: Math.random() * c.height,
        vx: (Math.random() - 0.5) * 0.4,
        vy: (Math.random() - 0.5) * 0.4
      });
    }

    function animate() {
      ctx.clearRect(0, 0, c.width, c.height);
      for (var i = 0; i < nodes.length; i++) {
        var a = nodes[i];
        a.x += a.vx;
        a.y += a.vy;
        if (a.x < 0 || a.x > c.width) a.vx *= -1;
        if (a.y < 0 || a.y > c.height) a.vy *= -1;
        for (var j = i + 1; j < nodes.length; j++) {
          var b = nodes[j];
          var dx = a.x - b.x;
          var dy = a.y - b.y;
          var dist = Math.sqrt(dx*dx + dy*dy);
          if (dist < 130) {
            ctx.strokeStyle = "rgba(52,152,219," + (1 - dist/130) + ")";
            ctx.beginPath();
            ctx.moveTo(a.x, a.y);
            ctx.lineTo(b.x, b.y);
            ctx.stroke();
          }
        }
      }
      requestAnimationFrame(animate);
    }
    animate();
  }

  // compute projection (1 alt income + 1 alt expense)
  function LOP_computeProjection() {
    var rentEl = document.getElementById('lop-rent');
    if (!rentEl) return null;

    // building composition (we keep it, even if currently not used in formula)
    var numStores   = Number(document.getElementById('lop-stores').value) || 0;
    var numApts     = Number(document.getElementById('lop-apartments').value) || 0;

    // money inputs
    var totalRentMonthly = Number(rentEl.value) || 0;
    var expensesMonthly  = Number(document.getElementById('lop-expenses').value) || 0;
    var mortgageMonthly  = Number(document.getElementById('lop-mortgage').value) || 0;
    var personalMonthly  = Number(document.getElementById('lop-personal').value) || 0;

    // growth
    var rentGrowth       = (Number(document.getElementById('lop-rent-growth').value) || 0) / 100;
    var expInflation     = (Number(document.getElementById('lop-exp-inflation').value) || 0) / 100;
    var appreciation     = (Number(document.getElementById('lop-appreciation').value) || 0) / 100;
    var years            = Number(document.getElementById('lop-years').value) || 1;
    var personalGrowth   = (Number(document.getElementById('lop-personal-growth').value) || 0) / 100;

    // tax/structure
    var personalTaxRate  = (Number(document.getElementById('lop-personal-tax').value) || 0) / 100;
    var corpTaxRate      = (Number(document.getElementById('lop-corp-tax').value) || 0) / 100;
    var useCorp          = Number(document.getElementById('lop-use-corp').value) === 1;
    var citySharePct     = (Number(document.getElementById('lop-city-share').value) || 0) / 100;
    var rebatePct        = (Number(document.getElementById('lop-rebate').value) || 0) / 100;

    // alt income / alt expense
    var altIncomeMonthly = Number(document.getElementById('lop-alt-income').value) || 0;
    var altExpenseMonthly= Number(document.getElementById('lop-alt-expense').value) || 0;

    // annualize
    var annualRent       = totalRentMonthly * 12;
    var annualExpenses   = expensesMonthly * 12;
    var annualMortgage   = mortgageMonthly * 12;
    var annualPersonal   = personalMonthly * 12;
    var annualAltIncome  = altIncomeMonthly * 12;
    var annualAltExpense = altExpenseMonthly * 12;

    // arrays
    var labels             = [];
    var incomeSeries       = [];
    var expenseSeries      = [];
    var netSeries          = [];
    var valueSeries        = [];
    var personalSeries     = [];
    var altIncomeSeries    = [];
    var altExpenseSeries   = [];
    var preTaxSeries       = [];
    var taxSeries          = [];
    var mathBlocks         = [];

    var currentValue       = 1000000;
    var firstProfitYear    = null;
    var bestYearIndex      = 1;
    var bestAfterTax       = -Infinity;

    for (var year = 1; year <= years; year++) {
      labels.push("Year " + year);

      // grow
      annualRent       *= (1 + rentGrowth);
      annualExpenses   *= (1 + expInflation);
      annualPersonal   *= (1 + personalGrowth);
      currentValue     *= (1 + appreciation);
      // alt income / expense we leave flat (0% growth) to match “I’d pay you monthly…”
      // but we could grow them too if we want

      // city tax logic
      var propertyTaxPart    = annualExpenses * citySharePct;
      var nonPropertyPart    = annualExpenses * (1 - citySharePct);
      var rebatedPropertyTax = propertyTaxPart * (1 - rebatePct);
      var finalBaseExpenses  = nonPropertyPart + rebatedPropertyTax + annualMortgage;
      // ADD alt expense to expenses:
      var finalExpensesWithAlt = finalBaseExpenses + annualAltExpense;

      // incomes
      var totalIncomeAnnual  = annualRent + annualAltIncome;

      // pre-tax
      var preTax             = totalIncomeAnnual - finalExpensesWithAlt;

      // tax
      var taxRateToUse       = useCorp ? corpTaxRate : personalTaxRate;
      var taxApplied         = Math.max(preTax, 0) * taxRateToUse;
      var afterTax           = preTax - taxApplied;

      incomeSeries.push(totalIncomeAnnual);
      expenseSeries.push(finalExpensesWithAlt);
      netSeries.push(afterTax);
      valueSeries.push(currentValue);
      personalSeries.push(annualPersonal);
      altIncomeSeries.push(annualAltIncome);
      altExpenseSeries.push(annualAltExpense);
      preTaxSeries.push(preTax);
      taxSeries.push(taxApplied);

      if (firstProfitYear === null && afterTax >= annualPersonal) {
        firstProfitYear = year;
      }
      if (afterTax > bestAfterTax) {
        bestAfterTax  = afterTax;
        bestYearIndex = year;
      }

      var formulaText =
        "Formulas used:\n" +
        "annual_rent = annual_rent × (1 + rentGrowth)\n" +
        "annual_expenses = annual_expenses × (1 + expInflation)\n" +
        "annual_personal = annual_personal × (1 + personalGrowth)\n" +
        "city_tax_part = annual_expenses × " + (citySharePct*100).toFixed(0) + "%\n" +
        "rebated_city_tax = city_tax_part × (1 - rebatePct[" + (rebatePct*100).toFixed(0) + "%])\n" +
        "base_final_expenses = non_city + rebated_city + mortgage\n" +
        "final_expenses = base_final_expenses + alt_expense\n" +
        "total_income = rent + alt_income\n" +
        "pre_tax = total_income - final_expenses\n" +
        "tax = max(pre_tax,0) × " + (taxRateToUse*100).toFixed(1) + "%\n" +
        "after_tax = pre_tax - tax";

      var yearHtml =
        "<div class='lop-year-block'>" +
          "<div class='lop-year-title'>===== YEAR " + year + " =====</div>" +
          "<table class='lop-math-table'>" +
            "<tr><td class='lop-math-label'>Base rent (annual, grown)</td><td class='lop-math-value'>$" + annualRent.toFixed(2) + "</td><td class='lop-math-delta lop-pos'>+" + annualRent.toFixed(2) + "</td></tr>" +
            "<tr><td class='lop-math-label'>Alt income (annual)</td><td class='lop-math-value'>$" + annualAltIncome.toFixed(2) + "</td><td class='lop-math-delta " + (annualAltIncome>=0?"lop-pos":"lop-neg") + "'>" + (annualAltIncome>=0?"+":"") + annualAltIncome.toFixed(2) + "</td></tr>" +
            "<tr><td class='lop-math-label'>Operating expenses (annual, grown)</td><td class='lop-math-value'>$" + annualExpenses.toFixed(2) + "</td><td class='lop-math-delta lop-neg'>-" + annualExpenses.toFixed(2) + "</td></tr>" +
            "<tr><td class='lop-math-label'> → city-tax portion (" + (citySharePct*100).toFixed(0) + "%)</td><td class='lop-math-value'>$" + propertyTaxPart.toFixed(2) + "</td><td class='lop-math-delta lop-neg'>-" + propertyTaxPart.toFixed(2) + "</td></tr>" +
            "<tr><td class='lop-math-label'> → rebate applied (" + (rebatePct*100).toFixed(0) + "%)</td><td class='lop-math-value'>$" + rebatedPropertyTax.toFixed(2) + "</td><td class='lop-math-delta " + (rebatePct>0?"lop-pos":"lop-neg") + "'>" + (rebatePct>0?"+":"") + (propertyTaxPart - rebatedPropertyTax).toFixed(2) + "</td></tr>" +
            "<tr><td class='lop-math-label'> → non-city portion (" + (100 - (citySharePct*100)) + "%)</td><td class='lop-math-value'>$" + nonPropertyPart.toFixed(2) + "</td><td class='lop-math-delta lop-neg'>-" + nonPropertyPart.toFixed(2) + "</td></tr>" +
            "<tr><td class='lop-math-label'>Mortgage (annual)</td><td class='lop-math-value'>$" + annualMortgage.toFixed(2) + "</td><td class='lop-math-delta lop-neg'>-" + annualMortgage.toFixed(2) + "</td></tr>" +
            "<tr><td class='lop-math-label'>Alt expense (annual)</td><td class='lop-math-value'>$" + annualAltExpense.toFixed(2) + "</td><td class='lop-math-delta lop-neg'>-" + annualAltExpense.toFixed(2) + "</td></tr>" +
            "<tr><td class='lop-math-label'><strong>Final expenses (with rebate + mortgage + alt)</strong></td><td class='lop-math-value'><strong>$" + finalExpensesWithAlt.toFixed(2) + "</strong></td><td class='lop-math-delta lop-neg'>-" + finalExpensesWithAlt.toFixed(2) + "</td></tr>" +
            "<tr><td class='lop-math-label'><strong>Pre-Tax = income - expenses</strong></td><td class='lop-math-value'><strong>$" + preTax.toFixed(2) + "</strong></td><td class='lop-math-delta " + (preTax>=0?"lop-pos":"lop-neg") + "'>" + (preTax>=0?"+":"") + preTax.toFixed(2) + "</td></tr>" +
            "<tr><td class='lop-math-label'>Tax rate used</td><td class='lop-math-value'>" + (taxRateToUse*100).toFixed(1) + "%</td><td class='lop-math-delta lop-neg'>-" + taxApplied.toFixed(2) + "</td></tr>" +
            "<tr><td class='lop-math-label'><strong>After-Tax Net</strong></td><td class='lop-math-value'><strong>$" + afterTax.toFixed(2) + "</strong></td><td class='lop-math-delta " + (afterTax>=0?"lop-pos":"lop-neg") + "'>" + (afterTax>=0?"+":"") + afterTax.toFixed(2) + "</td></tr>" +
            "<tr><td class='lop-math-label'>Owner personal target (annual)</td><td class='lop-math-value'>$" + annualPersonal.toFixed(2) + "</td><td class='lop-math-delta " + (afterTax - annualPersonal >= 0 ? "lop-pos" : "lop-neg") + "'>" + (afterTax - annualPersonal >= 0 ? "+" : "") + (afterTax - annualPersonal).toFixed(2) + "</td></tr>" +
          "</table>" +
          "<pre class='lop-math-formula'>" + formulaText + "</pre>" +
        "</div>";

      mathBlocks.push(yearHtml);
    }

    return {
      labels: labels,
      incomeSeries: incomeSeries,
      expenseSeries: expenseSeries,
      netSeries: netSeries,
      valueSeries: valueSeries,
      personalTargetSeries: personalSeries,
      altIncomeSeries: altIncomeSeries,
      altExpenseSeries: altExpenseSeries,
      preTaxSeries: preTaxSeries,
      taxSeries: taxSeries,
      mathHTML: mathBlocks.join(""),
      firstProfitYear: firstProfitYear,
      bestYearIndex: bestYearIndex,
      bestAfterTax: bestAfterTax
    };
  }

  // chart refs
  var LOP_incomeChart = null;
  var LOP_netChart    = null;
  var LOP_spiderChart = null;
  var LOP_valueChart  = null;
  var LOP_altChart    = null;
  var LOP_taxChart    = null;

  function LOP_renderCharts(data) {
    if (!data) return;

    var incomeCtx = document.getElementById('lop-income-chart');
    var netCtx    = document.getElementById('lop-net-chart');
    var spiderCtx = document.getElementById('lop-spider-chart');
    var valueCtx  = document.getElementById('lop-value-chart');
    var altCtx    = document.getElementById('lop-alt-chart');
    var taxCtx    = document.getElementById('lop-tax-chart');
    var summaryEl = document.getElementById('lop-summary');
    var mathTextEl = document.getElementById('lop-math-text');

    // summary
    if (summaryEl) {
      if (data.firstProfitYear !== null) {
        var targetForThatYear = data.personalTargetSeries[data.firstProfitYear - 1] || 0;
        summaryEl.className = "lop-summary--profit";
        summaryEl.innerHTML =
          "<h3>✅ Profitable starting in Year " + data.firstProfitYear + "</h3>" +
          "<p>After-tax net in Year " + data.firstProfitYear + " is $" +
          data.netSeries[data.firstProfitYear - 1].toFixed(2) +
          " which is ≥ your annual target $" + targetForThatYear.toFixed(2) + ".</p>";
      } else {
        summaryEl.className = "lop-summary--noprofit";
        summaryEl.innerHTML =
          "<h3>❌ Not profitable in " + data.labels.length + " years</h3>" +
          "<p>Best year is Year " + data.bestYearIndex +
          " with after-tax $" + data.bestAfterTax.toFixed(2) + ".</p>";
      }
    }

    // math
    if (mathTextEl) {
      mathTextEl.innerHTML = data.mathHTML;
    }

    if (!incomeCtx || !netCtx || !spiderCtx || !valueCtx || !altCtx || !taxCtx) {
      return;
    }

    // 1) income vs expenses
    if (LOP_incomeChart) LOP_incomeChart.destroy();
    LOP_incomeChart = new Chart(incomeCtx.getContext('2d'), {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: [
          { label: 'Total Income (Rent + Alt)', data: data.incomeSeries, borderColor: '#27ae60', borderWidth: 2, fill: false },
          { label: 'Total Expenses (incl. alt expense)', data: data.expenseSeries, borderColor: '#e74c3c', borderWidth: 2, fill: false }
        ]
      },
      options: { responsive: true, plugins: { title: { display: true, text: 'Income vs Expenses (Annual)' } } }
    });

    // 2) net vs target
    if (LOP_netChart) LOP_netChart.destroy();
    LOP_netChart = new Chart(netCtx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: data.labels,
        datasets: [
          { label: 'Net After Tax (CA$ / yr)', data: data.netSeries, backgroundColor: '#3498db' },
          { label: 'Your Target (to live)', data: data.personalTargetSeries, backgroundColor: 'rgba(231, 76, 60, 0.35)' }
        ]
      },
      options: { responsive: true, plugins: { title: { display: true, text: 'Owner Spendable vs Target' } } }
    });

    // 3) spider
    if (LOP_spiderChart) LOP_spiderChart.destroy();
    LOP_spiderChart = new Chart(spiderCtx.getContext('2d'), {
      type: 'radar',
      data: {
        labels: ['Rent', 'Alt Income', 'Alt Expense', 'After-Tax'],
        datasets: [
          {
            label: 'Year 1',
            data: [
              data.incomeSeries[0] - data.altIncomeSeries[0],
              data.altIncomeSeries[0],
              data.altExpenseSeries[0],
              data.netSeries[0]
            ],
            backgroundColor: 'rgba(52, 152, 219, 0.2)',
            borderColor: '#3498db'
          },
          {
            label: 'Year ' + data.labels[data.labels.length - 1],
            data: [
              data.incomeSeries[data.incomeSeries.length - 1] - data.altIncomeSeries[data.altIncomeSeries.length - 1],
              data.altIncomeSeries[data.altIncomeSeries.length - 1],
              data.altExpenseSeries[data.altExpenseSeries.length - 1],
              data.netSeries[data.netSeries.length - 1]
            ],
            backgroundColor: 'rgba(39, 174, 96, 0.2)',
            borderColor: '#27ae60'
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { title: { display: true, text: 'Composition (Start vs End)' } },
        scales: { r: { beginAtZero: true } }
      }
    });

    // 4) property value vs costs
    if (LOP_valueChart) LOP_valueChart.destroy();
    LOP_valueChart = new Chart(valueCtx.getContext('2d'), {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: [
          { label: 'Property Value (paper)', data: data.valueSeries, borderColor: '#8e44ad', borderWidth: 2, fill: false },
          { label: 'Expenses (incl. alt)', data: data.expenseSeries, borderColor: '#e67e22', borderWidth: 2, fill: false }
        ]
      },
      options: { responsive: true, plugins: { title: { display: true, text: 'Paper Growth vs Real Cost Growth' } } }
    });

    // 5) alt income vs alt expense
    if (LOP_altChart) LOP_altChart.destroy();
    LOP_altChart = new Chart(altCtx.getContext('2d'), {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: [
          { label: 'Alt Income', data: data.altIncomeSeries, borderColor: '#16a085', borderWidth: 2, fill: false },
          { label: 'Alt Expense', data: data.altExpenseSeries, borderColor: '#c0392b', borderWidth: 2, fill: false }
        ]
      },
      options: { responsive: true, plugins: { title: { display: true, text: 'Alt Income vs Alt Expense' } } }
    });

    // 6) pre-tax vs tax paid
    if (LOP_taxChart) LOP_taxChart.destroy();
    LOP_taxChart = new Chart(taxCtx.getContext('2d'), {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: [
          { label: 'Pre-Tax', data: data.preTaxSeries, borderColor: '#2c3e50', borderWidth: 2, fill: false },
          { label: 'Tax Paid', data: data.taxSeries, borderColor: '#c0392b', borderWidth: 2, fill: false }
        ]
      },
      options: { responsive: true, plugins: { title: { display: true, text: 'Pre-Tax vs Tax Paid' } } }
    });
  }

  // global entry
  window.generateProjection = function() {
    var data = LOP_computeProjection();
    if (!data) return;
    if (!window.Chart) {
      alert("Chart.js not available yet.");
      return;
    }
    LOP_renderCharts(data);
  };

  // hook into loadProject
  if (window.loadProject) {
    var _origLoadProject = window.loadProject;
    window.loadProject = function(page) {
      _origLoadProject(page);
      setTimeout(function() {
        if (page.indexOf('landlord_optimization.html') !== -1) {
          LOP_initSpiderBackground();
          LOP_ensureChartJs(function() {
            window.generateProjection();
          });
        }
      }, 100);
    };
  } else {
    document.addEventListener('DOMContentLoaded', function() {
      if (document.getElementById('landlord-optimizer')) {
        LOP_initSpiderBackground();
        LOP_ensureChartJs(function() {
          window.generateProjection();
        });
      }
    });
  }
  </script>

</body>
</html>
